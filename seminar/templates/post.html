{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{post.title}}</title>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <script src="../static/js/bootstrap.min.js"></script>

</head>
<script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function deletePost() {
        console.log("start");
        const res = await fetch("{% url 'posts.select' post.pk %}", {
            credentials: 'include',
            method: 'DELETE',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
        });
        const json = res.json();
        if (!res.ok) alert('삭제에 실패했습니다.')
        else window.location.href = '{% url 'main' %}';
    }
    async function deleteComment(url) {
        const res = await fetch(url, {
            credentials: 'include',
            method: 'DELETE',
            mode: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
        });
        const json = res.json();
        window.location.href = '{% url 'posts.select' post.pk %}';
    }
</script>

<body>
    <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between px-5">
            <a class="navbar-brand" href="{% url 'main' %}">Seminar</a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link ml-3" href="{% url 'posts.create' %}">작성하기 <span
                            class="sr-only">(current)</span></a>
                </li>
            </ul>
            {% if user.is_authenticated %}
            <a class="nav-link disabled ml-auto" href='{% url 'posts.create' %}'>{{ user.username }}님</a>
            <form class="form-inline my-2 my-lg-0 " action="{% url 'logout' %}">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">로그아웃</button>
            </form>

            {% else %}
            <form class="form-inline my-2 my-lg-0 ml-auto" action="{% url 'register' %}">
                <button class="btn btn-outline-light my-2 my-sm-0" type="submit">회원가입</button>
            </form>
            <form class="form-inline my-2 my-lg-0 ml-2" action="{% url 'login' %}">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">로그인</button>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="my-3 p-3 rounded shadow-sm container">
        <h1 class=" pb-2 mb-0">{{ post.title }}</h1>
        <span class="fc-light mr2 border-gray border-bottom">Post</span>
        <div class="media text-muted pt-3">
        <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
            <strong class="d-block text-gray-dark">@username</strong>
            Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.
        </p>
    </div>
    <small class="d-block text-right mt-3">
      <a href="#">All updates</a>
    </small>
    </div>
    {% if post.writer.username == user.username %}
    <button onclick="window.location.href = '{% url 'posts.edit' post.pk %}';">
        수정하기
    </button>

    <button onclick="deletePost()">
        삭제하기
    </button>
    {% endif %}

    <br>


    {% if post %}
        <div class="context">
            <h1>{{ post.title }}</h1>
                <div>
                    <a>{{post.writer.username}} {{post.created_at}}</a>
                </div>
            <hr>
            <div>{{ post.content }}</div>
            <br>
            <a>투표 수 : {{post.vote_count}}</a>

            <a href="{% url 'posts.vote' post.pk %}">
                {% if recommends %}
                투표 취소
                {% else %}
                투표
                {% endif %}
            </a>

            {% if post.writer != user %}
            <br>

            {% endif %}
            <hr>
            <form action="{% url 'posts.comments.create' post.pk%}" method="POST">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Write your comments">
                <input type="submit" value="Write">
            </form>


            <hr>

            {% for comment in comments %}
                <div class="comment">
                    <a>{{comment.comment_date}}</a>
                    <strong> {{comment.comment_writer}} </strong>
                    {% if comment.comment_writer == user %}
                    <button onclick="deleteComment('{% url 'posts.comments.select' comment.pk %}');">
                        삭제하기
                    </button>
                    {% endif %}
                    <br>
                    <a>{{ comment.comment_content }}</a>
                </div>
                {% empty %}
                <p>No comments here yet</p>
            {% endfor %}
            
        </div>
    {% else %}
        <p>존재하지 않거나 삭제된 글</p>
    {% endif %}


   
</body>

</html>